---
title: "GBIF-based Functions for Occurrence Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GBIF-based Functions for Occurrence Data}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

```{r setup}
library(taxinfo)
library(MiscMetabar)
library(ggplot2)
library(dplyr)
```


## Overview

The Global Biodiversity Information Facility (GBIF) is the world's largest repository of biodiversity occurrence data. The taxinfo package provides seamless integration with GBIF through specialized functions that retrieve occurrence data, create distribution maps, and analyze biogeographic patterns for taxa in your phyloseq objects.

## Core GBIF Functions

- `tax_gbif_occur_pq()`: Retrieve occurrence counts from GBIF
- `plot_tax_gbif_pq()`: Create distribution maps
- `range_bioreg_pq()`: Analyze biogeographic ranges
- `tax_check_ecoregion()`: Validate occurrences against ecoregions
- `tax_occur_check_pq()`: Check occurrences within a geographic radius

**Note:** Functions like `tax_gbif_occur_pq()` and `tax_occur_check_pq()` can work with either phyloseq objects or vectors of taxonomic names (`taxnames` parameter). When using a phyloseq object, results are automatically added to the tax_table. When using `taxnames`, a tibble is returned.

## Basic Occurrence Data Retrieval

### Global Occurrence Counts

```{r}
# Load and prepare example data
data("data_fungi_mini", package = "MiscMetabar")

# Clean taxonomic names first (recommended)
data_clean <- gna_verifier_pq(data_fungi_mini, data_sources = 210) |>
# Get global occurrence counts from GBIF
 tax_gbif_occur_pq(data_clean)
```

### Example Visualization 

Here's an example of what GBIF occurrence data visualization can look like:
 
```{r echo=FALSE, fig.cap="GBIF occurrence counts by taxon", out.width="100%"}
data_clean_gbif@tax_table |>
  as.data.frame() |>
  mutate(occurrences = as.numeric(Global_occurences)) |>
  filter(!is.na(occurrences), occurrences > 0) |>
  distinct(currentCanonicalSimple, .keep_all = TRUE) |>
  ggplot(aes(x = forcats::fct_reorder(currentCanonicalSimple, occurrences), y = log10(1 + occurrences))) +
  geom_col(aes(fill = Order), alpha = 0.7) +
  coord_flip() +
  labs(
    title = "GBIF Occurrence Counts by Taxon",
    x = "Taxon",
    y = "Number of occurrences (log scale)"
  ) +
  theme_idest() +
  theme(axis.text.y = element_text(face = "italic"))
```

### Occurrence Counts by Country

Analyze geographic distribution patterns:

```{r}
data_clean_gbif_country <- tax_gbif_occur_pq(data_clean, by_country = TRUE)

data_clean_gbif_country@tax_table |>
  as.data.frame() |>
  select(currentCanonicalSimple, US, FR, DE, GB, ES, MX) |>
  tidyr::pivot_longer(
    cols = c(US, FR, DE, GB, ES, MX),
    names_to = "country",
    values_to = "occurrences"
  ) |>
  mutate(occurrences = as.numeric(occurrences)) |>
  filter(!is.na(occurrences), occurrences > 0) |>
  ggplot(aes(x = country, y = occurrences, fill = country)) +
  geom_violin() +
  geom_jitter(width = 0.2, alpha = 0.5) +
  scale_y_log10() +
  stat_summary(
    fun.data = function(x) {
      return(data.frame(y = max(x) + 0.1, label = paste("n =", length(x))))
    },
    geom = "text",
    vjust = 0
  ) +
  labs(
    title = "GBIF Occurrences by Country",
    x = "Country",
    y = "Number of occurrences (log scale)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

### Temporal Patterns

Examine occurrence trends over time. Here we don't use `add_to_phyloseq` since the data frame output is 
sufficient.

```{r}
gbif_years <- tax_gbif_occur_pq(data_clean, by_years = TRUE)

# Visualize temporal trends for the occurences of taxa
gbif_years |>
  mutate(year = as.numeric(name)) |>
  ggplot(aes(x = year, y = log10(count + 1), color = canonicalName)) +
  geom_line() +
  geom_point() +
  labs(
    title = "GBIF Occurrences Over Time",
    x = "Year",
    y = "Number of GBIF occurrences"
  ) +
  theme_idest() +
  ggrepel::geom_text_repel(
    data = summarise(group_by(arrange(gbif_years, desc(name)), canonicalName), count = first(count), name = first(name)),
    aes(label = canonicalName, x = as.numeric(name)), hjust = 0, direction = "y", size = 3
  ) +
  xlim(2010, 2026) +
  theme(legend.position = "none")
```

```{r}
gbif_years_cumsum <- gbif_years |>
  mutate(year = as.numeric(name)) |>
  arrange(year) |>
  group_by(canonicalName) |>
  mutate(year = as.numeric(name)) |>
  mutate(cum_count = cumsum(count))

ggplot(gbif_years_cumsum, aes(x = year, y = log10(cum_count + 1), color = canonicalName)) +
  geom_line() +
  geom_point() +
  labs(
    title = "GBIF Cumulative Occurrences Over Time",
    x = "Year",
    y = "Number of GBIF occurrences"
  ) +
  theme_idest() +
  ggrepel::geom_text_repel(
    data = summarise(group_by(arrange(gbif_years_cumsum, desc(name)), canonicalName), cum_count = first(cum_count), name = first(name)),
    aes(label = canonicalName, x = as.numeric(name)), hjust = 0, direction = "y", size = 3
  ) +
  xlim(2010, 2026) +
  theme(legend.position = "none")
```


## Visualization and Mapping

### Basic Distribution Plots

Create occurrence distribution visualizations:

```{r}
# Plot global vs regional occurrences
psmelt(data_clean_gbif) |>
  as.data.frame() |>
  group_by(currentCanonicalSimple) |>
  summarise(
    Global_occurences = as.numeric(unique(Global_occurences)),
    nb_seq = sum(Abundance),
    nb_samp = sum(Abundance > 0)
  ) |>
  filter(!is.na(Global_occurences)) |>
  ggplot(aes(
    x = log10(1 + nb_seq),
    y = log10(1 + Global_occurences)
  )) +
  geom_point(alpha = 0.7) +
  ggrepel::geom_text_repel(aes(label = currentCanonicalSimple),
    vjust = -0.5,
    size = 3,
    fontface = "italic",
    min.segment.length = 0.2,
    force = 4
  ) +
  coord_flip() +
  labs(
    title = "GBIF Occurrence Counts by Taxon",
    x = "Number of sequences (log scale)",
    y = "Number of GBIF occurrences (log scale)"
  ) +
  theme_idest()
```

### Interactive Distribution Maps

Create interactive maps showing species distributions:

```{r}
plot_tax_gbif_pq(select_taxa_pq(data_clean, taxnames = "Ossicaulis lachnopus"),
  interactive_plot = TRUE
)
```


### Static Distribution Maps


```{r}
distribution_maps <- plot_tax_gbif_pq(
  taxnames = c("Ossicaulis lachnopus", "Basidiodendron eyrei"),
  n_occur = 1000
)
distribution_maps[[1]] 
```



## Biogeographic Analysis

### Range Analysis

```{r}
data_clean_range <- range_bioreg_pq(
  select_taxa_pq(data_clean,
    taxnames = c("Ossicaulis lachnopus", "Basidiodendron eyrei")
  ),
  make_plot = TRUE
)
```

```{r}
data_clean_range[[2]]
```

### Ecoregion Validation

Check if occurrences match expected ecoregions:

```{r}
tax_check_ecoregion("Xylobolus subpileatus",
  longitudes = c(2.3522, 4.2),
  latitudes = c(48.8566, 33)
)
```
